<Page x:Class="BKFluentChat.Views.Pages.ChatPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:local="clr-namespace:BKFluentChat.Views.Pages"
      xmlns:models="clr-namespace:BKFluentChat.Models"
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      mc:Ignorable="d" 
      d:DataContext="{d:DesignInstance Type=local:ChatPage, IsDesignTimeCreatable=False}"
      d:DesignHeight="450"
      d:DesignWidth="800"
      Title="ChatPage">

    <Page.Resources>
        <DataTemplate x:Key="ConversationItemTemplate" DataType="{x:Type models:Conversation}">
            <Grid Height="65" Background="Transparent">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Avatar -->
                <Ellipse Grid.Column="0" Width="48" Height="48" Margin="10,0" VerticalAlignment="Center">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding AvatarUrl}"/>
                    </Ellipse.Fill>
                </Ellipse>

                <!-- Name and Latest Message -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="{Binding Name}" Foreground="White" FontSize="15" Margin="0,0,0,4"/>
                    <TextBlock Text="{Binding LatestMessage}" Foreground="#FF8F8F8F" FontSize="13" TextTrimming="CharacterEllipsis"/>
                </StackPanel>

                <!-- Timestamp and Mute Icon -->
                <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right" Margin="10,0">
                    <TextBlock Text="{Binding Timestamp}" Foreground="#FF8F8F8F" FontSize="12" Margin="0,0,0,4"/>
                    <!-- Mute Icon: Visible only if IsMuted is true -->
                    <ui:SymbolIcon Symbol="SpeakerMute24" Foreground="#FF8F8F8F">
                        <ui:SymbolIcon.Style>
                            <Style TargetType="ui:SymbolIcon">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ui:SymbolIcon.Style>
                    </ui:SymbolIcon>
                </StackPanel>
            </Grid>
        </DataTemplate>

        <!-- (聊天消息模板，来自上一步，保持不变) -->
        <!-- 请用这段完整的代码替换您文件中对应的 DataTemplate -->
        <DataTemplate x:Key="ChatMessageTemplate" DataType="{x:Type models:ChatMessage}">
            <Grid Margin="0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <!-- Column 0: Left Avatar -->
                    <ColumnDefinition Width="*"/>
                    <!-- Column 1: Content -->
                    <ColumnDefinition Width="Auto"/>
                    <!-- Column 2: Right Avatar -->
                </Grid.ColumnDefinitions>

                <!-- 左侧头像：默认可见 -->
                <Ellipse x:Name="AvatarEllipseLeft" Grid.Column="0" Width="40" Height="40" Margin="0,0,10,0" VerticalAlignment="Top">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding AvatarUrl,FallbackValue={StaticResource DefaultAvatar}}"/>
                    </Ellipse.Fill>
                </Ellipse>

                <!-- 中间的消息内容主体 -->
                <StackPanel x:Name="ContentPanel" Grid.Column="1" HorizontalAlignment="Left">
                    <!-- 作者名字：默认可见 -->
                    <TextBlock x:Name="AuthorTextBlock" Text="{Binding Author}" Foreground="Gray" Margin="5,0,0,5" HorizontalAlignment="Left"/>

                    <!-- 聊天气泡 -->
                    <Border x:Name="BubbleBorder" 
                    Background="#FF4F4F4F"
                    CornerRadius="8"
                    Padding="12"
                    MaxWidth="450">
                        <TextBlock Text="{Binding Text}" Foreground="White" FontSize="14" TextWrapping="Wrap"/>
                    </Border>
                </StackPanel>

                <!-- 右侧头像：默认折叠/隐藏 -->
                <Ellipse x:Name="AvatarEllipseRight" Grid.Column="2" Width="40" Height="40" Margin="10,0,0,0" VerticalAlignment="Top" Visibility="Collapsed">
                    <Ellipse.Fill>
                        <ImageBrush ImageSource="{Binding AvatarUrl,FallbackValue={StaticResource DefaultAvatar}}"/>
                    </Ellipse.Fill>
                </Ellipse>
            </Grid>

            <!-- 使用DataTemplate的触发器来改变整个消息项的布局和样式 -->
            <DataTemplate.Triggers>
                <!-- 如果是自己发送的消息 (IsSentByMe == True) -->
                <DataTrigger Binding="{Binding IsSentByMe}" Value="True">
                    <!-- 1. 将内容面板和作者名字居右对齐 -->
                    <Setter TargetName="ContentPanel" Property="HorizontalAlignment" Value="Right"/>
                    <Setter TargetName="AuthorTextBlock" Property="HorizontalAlignment" Value="Right"/>

                    <!-- 2. 更改气泡颜色 -->
                    <Setter TargetName="BubbleBorder" Property="Background" Value="#FF597A53"/>

                    <!-- 3. 隐藏左侧头像，显示右侧头像 -->
                    <Setter TargetName="AvatarEllipseLeft" Property="Visibility" Value="Collapsed"/>
                    <Setter TargetName="AvatarEllipseRight" Property="Visibility" Value="Visible"/>

                    <!-- 4. 隐藏自己的作者名字 -->
                    <Setter TargetName="AuthorTextBlock" Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </DataTemplate.Triggers>
        </DataTemplate>
    </Page.Resources>

    <!-- 主布局：分为左右两栏 -->
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <!-- 左侧会话列表 -->
            <ColumnDefinition Width="Auto"/>
            <!-- 分割线 -->
            <ColumnDefinition Width="144*"/>
            <ColumnDefinition Width="355*"/>
            <!-- 右侧聊天窗口 -->
        </Grid.ColumnDefinitions>

        <!-- ============================================= -->
        <!--        左侧会话列表 (Column 0)              -->
        <!-- ============================================= -->
        <Border Grid.Column="0" Background="#333333">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <!-- 搜索框 -->
                <Border Padding="10" BorderThickness="0,0,0,1" BorderBrush="#FF4A4A4A">
                    <ui:TextBox PlaceholderText="搜索" Icon="{ui:SymbolIcon Search24}"/>
                </Border>
                <!-- 会话列表 -->
                <!-- 会话列表 -->
                <ListView Grid.Row="1"
                          ItemsSource="{Binding ViewModel.Conversations}"
                          ItemTemplate="{StaticResource ConversationItemTemplate}"
                          SelectedItem="{Binding ViewModel.SelectedConversation, Mode=TwoWay}"
                          Background="Transparent"
                          BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0"/>
                            <!-- 添加选中时的背景色 -->
                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#FF4A4A4A"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ListView.ItemContainerStyle>
                </ListView>
            </Grid>
        </Border>

        <!-- ============================================= -->
        <!--           分割线 (Column 1)                  -->
        <!-- ============================================= -->
        <GridSplitter Grid.Column="1" Width="1" Background="#FF4A4A4A" HorizontalAlignment="Stretch" />

        <!-- ============================================= -->
        <!--        右侧聊天窗口 (Column 2)              -->
        <!-- ============================================= -->
        <Grid Grid.Column="2" Grid.ColumnSpan="2">
            <Grid x:Name="ChatPanel">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Setter Property="Visibility" Value="Visible"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding ViewModel.SelectedConversation}" Value="{x:Null}">
                                <Setter Property="Visibility" Value="Collapsed"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <!-- 聊天消息 -->
                    <RowDefinition Height="Auto"/>
                    <!-- 消息输入区域 -->
                </Grid.RowDefinitions>
                <!-- 当没有选中会话时，显示提示信息 -->


                <!-- 聊天消息列表 (代码和之前一样) -->
                <ScrollViewer Grid.Row="0" x:Name="MessageScrollViewer" VerticalScrollBarVisibility="Auto">
                    <!-- 正确的代码 -->
                    <!--<ItemsControl ItemsSource="{Binding ViewModel.SelectedConversation.Messages}" 
                              ItemTemplate="{StaticResource ChatMessageTemplate}" 
                              Margin="20,20,20,0"/>-->
                    <ItemsControl ItemsSource="{Binding ViewModel.CurrentMessages}" 
                                  ItemTemplate="{StaticResource ChatMessageTemplate}" 
                                  Margin="20,20,20,0"/>
                </ScrollViewer>

                <!-- 消息输入区域 (代码和之前一样) -->
                <Border Grid.Row="1" MinHeight="100" BorderBrush="#FF4A4A4A" BorderThickness="0,1,0,0" Padding="10">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="😀 ✂️ 📂 🖼️ 🎤 💬" Foreground="#FF9E9E9E" Margin="0,0,0,5" FontSize="20"/>
                        <ui:TextBox Grid.Row="1" Text="{Binding ViewModel.NewMessageText, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" TextWrapping="Wrap" Background="Transparent" BorderThickness="0" Foreground="White" FontSize="14" VerticalContentAlignment="Top" PlaceholderText="输入消息..."/>
                        <Button Grid.Row="2" Content="发送" Command="{Binding ViewModel.SendMessageCommand}" HorizontalAlignment="Right" Padding="20,5" Background="#FF597A53" Foreground="White" BorderThickness="0"/>
                    </Grid>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</Page>